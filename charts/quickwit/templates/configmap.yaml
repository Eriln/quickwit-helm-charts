apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "quickwit.fullname" . }}
  labels:
    {{- include "quickwit.labels" . | nindent 4 }}
data:
  node.yaml: |-
    version: 0.8
    listen_address: 0.0.0.0
    gossip_listen_port: 7282
    data_dir: /quickwit/qwdata
    default_index_root_uri: {{ .Values.config.default_index_root_uri }}
    {{- with .Values.config.indexer }}
    indexer:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    {{- with .Values.config.storage }}
    storage:
      {{- if .s3 }}
      s3:
        {{- if .s3.endpoint }}
        endpoint: "{{ .s3.endpoint }}"
        {{- end }}
        {{- if .s3.region }}
        region: "{{ .s3.region }}"
        {{- end }}
        {{- if .s3.access_key_id }}
        access_key_id: "{{ .s3.access_key_id }}"
        {{- end }}
        {{- if or (.s3.secret_access_key) (.s3.secret_access_key_secret_key_ref) }}
        secret_access_key: ${AWS_SECRET_ACCESS_KEY}
        {{- end }}
      {{- end }}
      {{- if .azure }}
      azure:
        {{- if .azure.account }}
        account: "{{ .azure.account }}"
        {{- end }}
        {{- if or (.azure.access_key) (.azure.access_key_secret_key_ref) }}
        access_key: ${QW_AZURE_STORAGE_ACCESS_KEY}
        {{- end }}
      {{- end }}
    {{- end }}
    {{- with .Values.config.ingest_api }}
    ingest_api:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    {{- with .Values.config.searcher }}
    searcher:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    {{- with .Values.config.jaeger }}
    jaeger:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    {{- if (.Values.config.postgres).max_num_connections }}
    metastore:
      postgres:
        max_num_connections: {{ .Values.config.postgres.max_num_connections }}
    {{- end }}
